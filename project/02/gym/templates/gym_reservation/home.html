{% extends 'base.html' %}

{% block title %}
    Ronish Gym Reservation - Home
{% endblock %}

{% block content %}
    <!-- Main Content Section -->
    <main class="container mt-4">
        <h1 class="text-center">Select a Gym</h1>
        <div class="row">
            <!-- First Gym Card -->
            <div class="col-md-6 mb-4">
                <div class="card text-center">
                    <img src="https://via.placeholder.com/400x200.png?text=Gym+1" class="card-img-top" alt="Gym 1">
                    <div class="card-body">
                        <h5 class="card-title">Gym 1</h5>
                        <!-- Check if Gym 1 is open or reserved -->
                        {% if gym1_is_open %}
                            <div class="gym-status status-open bg-success text-white py-2">Open</div>
                            <div class="text-center mb-4 d-flex justify-content-center gap-3">
                                <a href="#" class="btn btn-info start-workout-btn" data-gym-id="{{ gym1.id }}" data-url="{% url 'start_workout' gym1.id %}">I'm Working Out</a>
                                <a href="#" class="btn btn-secondary end-workout-btn" data-gym-id="{{ gym1.id }}" data-url="{% url 'end_workout' gym1.id %}">I'm Done Working Out</a>
                                
                            </div>
                            <a href="{% url 'reservations' gym1.id %}" class="btn btn-primary mt-3">Make a Reservation</a>
                        {% else %}
                            <div class="gym-status status-occupied bg-danger text-white py-2">Occupied</div>
                            <a href="#" class="btn btn-primary mt-3 disabled">Make a Reservation</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Second Gym Card -->
            <div class="col-md-6 mb-4">
                <div class="card text-center">
                    <img src="https://via.placeholder.com/400x200.png?text=Gym+2" class="card-img-top" alt="Gym 2">
                    <div class="card-body">
                        <h5 class="card-title">Gym 2</h5>
                        <!-- Check if Gym 2 is open or reserved -->
                        {% if gym2_is_open %}
                            <div class="gym-status status-open bg-success text-white py-2">Open</div>
                            <div class="text-center mb-4 d-flex justify-content-center gap-3">
                                <a href="#" class="btn btn-info start-workout-btn" data-gym-id="{{ gym2.id }}" data-url="{% url 'start_workout' gym2.id %}">I'm Working Out</a>
                                <a href="#" class="btn btn-secondary end-workout-btn" data-gym-id="{{ gym2.id }}" data-url="{% url 'end_workout' gym2.id %}">I'm Done Working Out</a>                                

                            </div>
                            <a href="{% url 'reservations' gym2.id %}" class="btn btn-primary mt-3">Make a Reservation</a>
                        {% else %}
                            <div class="gym-status status-occupied bg-danger text-white py-2">Occupied</div>
                            <a href="#" class="btn btn-primary mt-3 disabled">Make a Reservation</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

        <!-- Including jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <script>
        $(document).ready(function () {
            // Connect to the WebSocket
            const socket = new WebSocket('ws://' + window.location.host + '/ws/gym-status/');

            // Log WebSocket connection status
            socket.onopen = function () {
                console.log('WebSocket connected.');
            };

            socket.onerror = function (error) {
                console.error('WebSocket error:', error);
            };

            socket.onclose = function () {
                console.log('WebSocket closed.');
            };

            // Handle incoming messages
            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                const gymId = data.gym_id;
                const status = data.status;

                // Update the DOM based on the status
                const statusDiv = $(`.card:has([data-gym-id="${gymId}"])`).find('.gym-status');
                if (status === 'open') {
                    statusDiv.removeClass('bg-danger').addClass('bg-success').text('Open');
                } else if (status === 'occupied') {
                    statusDiv.removeClass('bg-success').addClass('bg-danger').text('Occupied');
                }
            };
        // Send a status update when buttons are clicked
        $('.start-workout-btn').click(function (event) {
            event.preventDefault();
            const gymId = $(this).data('gym-id');
            socket.send(JSON.stringify({ gym_id: gymId, status: 'occupied' }));
        });

        $('.end-workout-btn').click(function (event) {
            event.preventDefault();
            const gymId = $(this).data('gym-id');
            socket.send(JSON.stringify({ gym_id: gymId, status: 'open' }));
            });
        });

    </script>
{% endblock %}