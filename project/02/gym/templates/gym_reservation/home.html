{% extends 'base.html' %}

{% block title %}
    Ronish Gym Reservation - Home
{% endblock %}

{% block content %}
    <!-- Main Content Section -->
    <main class="container mt-4">
        <h1 class="text-center">Select a Gym</h1>
        <div class="row">
            <!-- Loop through both gyms to avoid duplicate code -->
            {% for gym, is_open in gyms %}
            <div class="col-md-6 mb-4">
                <div class="card text-center">
                    <img src="https://via.placeholder.com/400x200.png?text=Gym+{{ gym.id }}" class="card-img-top" alt="Gym {{ gym.id }}">
                    <div class="card-body">
                        <h5 class="card-title">Gym {{ gym.id }}</h5>

                        <!-- Gym Status Bar -->
                        <div class="gym-status 
                                    {% if is_open %}
                                        bg-success text-white
                                    {% else %}
                                        bg-danger text-white
                                    {% endif %} py-2">
                            {% if is_open %}
                                Open
                            {% else %}
                                Occupied
                            {% endif %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center mb-4 d-flex justify-content-center gap-3">
                            <!-- Start Workout Button -->
                            <a href="#" class="btn btn-info start-workout-btn 
                                {% if not is_open %}d-none{% endif %}" 
                                data-gym-id="{{ gym.id }}" 
                                data-url="{% url 'start_workout' gym.id %}">
                                I'm Working Out
                            </a>

                            <!-- End Workout Button -->
                            <a href="#" class="btn btn-secondary end-workout-btn 
                                {% if is_open %}d-none{% endif %}" 
                                data-gym-id="{{ gym.id }}" 
                                data-url="{% url 'end_workout' gym.id %}">
                                I'm Done Working Out
                            </a>
                        </div>

                        <!-- Reservation Button -->
                        <a href="{% url 'reservations' gym.id %}" 
                        class="btn btn-primary mt-3 {% if not is_open %}disabled{% endif %}">
                        Make a Reservation
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Handle "I'm Working Out" button click
            $('.start-workout-btn').click(function(event) {
                event.preventDefault();
                const btn = $(this);
                const gymId = btn.data('gym-id');
                
                // Send AJAX request to start workout
                $.ajax({
                    url: btn.data('url'),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            // Update the gym status to "Occupied"
                            const statusDiv = btn.closest('.card').find('.gym-status');
                            statusDiv.removeClass('bg-success').addClass('bg-danger').text('Occupied');

                            // Toggle visibility of buttons
                            btn.addClass('d-none');
                            btn.siblings('.end-workout-btn').removeClass('d-none');

                            // Disable reservation button
                            const reservationBtn = btn.closest('.card').find('.btn-primary');
                            reservationBtn.addClass('disabled');
                        }
                    },
                    error: function() {
                        alert('Failed to start workout. Please try again.');
                    }
                });
            });

            // Handle "I'm Done Working Out" button click
            $('.end-workout-btn').click(function(event) {
                event.preventDefault();
                const btn = $(this);
                const gymId = btn.data('gym-id');
                
                // Send AJAX request to end workout
                $.ajax({
                    url: btn.data('url'),
                    type: 'GET',
                    success: function(response) {
                        if (response.status === 'success') {
                            // Update the gym status to "Open"
                            const statusDiv = btn.closest('.card').find('.gym-status');
                            statusDiv.removeClass('bg-danger').addClass('bg-success').text('Open');

                            // Toggle visibility of buttons
                            btn.addClass('d-none');
                            btn.siblings('.start-workout-btn').removeClass('d-none');

                            // Enable reservation button
                            const reservationBtn = btn.closest('.card').find('.btn-primary');
                            reservationBtn.removeClass('disabled');
                        }
                    },
                    error: function() {
                        alert('Failed to end workout. Please try again.');
                    }
                });
            });
        });
    </script>
{% endblock %}
