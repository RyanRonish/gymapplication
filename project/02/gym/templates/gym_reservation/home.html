{% extends 'base.html' %}
{% load static %}

{% block title %}
    Ronish Gym Reservation - Home
{% endblock %}

{% block content %}
<main class="container mt-4">
    <h1 class="text-center">Select a Gym</h1>
    <div class="row">
        <!-- Gym 1 Card -->
        <div class="col-md-6 mb-4">
            <div class="card text-center">
                <img src="https://via.placeholder.com/400x200.png?text=Gym+1" class="card-img-top" alt="Gym 1">
                <div class="card-body">
                    <h5 class="card-title">Gym 1</h5>
                    <!-- Status Bar -->
                    <div id="gym-status-1" class="gym-status 
                                {% if gym1_is_open %}
                                    bg-success text-white
                                {% else %}
                                    bg-danger text-white
                                {% endif %} py-2">
                        {% if gym1_is_open %}
                            Open
                        {% else %}
                            Occupied
                        {% endif %}
                    </div>
                    <!-- Buttons -->
                    <div class="text-center mb-4 d-flex justify-content-center gap-3">
                        <button id="start-workout-1" class="btn btn-info 
                                {% if not gym1_is_open %}d-none{% endif %}" 
                                data-gym-id="{{ gym1.id }}" 
                                data-url="{% url 'start_workout' gym1.id %}">
                            I'm Working Out
                        </button>
                        <button id="end-workout-1" class="btn btn-secondary 
                                {% if gym1_is_open %}d-none{% endif %}" 
                                data-gym-id="{{ gym1.id }}" 
                                data-url="{% url 'end_workout' gym1.id %}">
                            I'm Done Working Out
                        </button>
                    </div>
                    <!-- Reservation Button -->
                    <a href="{% url 'reservations' gym1.id %}" id="reservation-btn-1" class="btn btn-primary mt-3 
                            {% if not gym1_is_open %}disabled{% endif %}">
                        Make a Reservation
                    </a>
                </div>
            </div>
        </div>

        <!-- Gym 2 Card -->
        <div class="col-md-6 mb-4">
            <div class="card text-center">
                <img src="https://via.placeholder.com/400x200.png?text=Gym+2" class="card-img-top" alt="Gym 2">
                <div class="card-body">
                    <h5 class="card-title">Gym 2</h5>
                    <!-- Status Bar -->
                    <div id="gym-status-2" class="gym-status 
                                {% if gym2_is_open %}
                                    bg-success text-white
                                {% else %}
                                    bg-danger text-white
                                {% endif %} py-2">
                        {% if gym2_is_open %}
                            Open
                        {% else %}
                            Occupied
                        {% endif %}
                    </div>
                    <!-- Buttons -->
                    <div class="text-center mb-4 d-flex justify-content-center gap-3">
                        <button id="start-workout-2" class="btn btn-info 
                                {% if not gym2_is_open %}d-none{% endif %}" 
                                data-gym-id="{{ gym2.id }}" 
                                data-url="{% url 'start_workout' gym2.id %}">
                            I'm Working Out
                        </button>
                        <button id="end-workout-2" class="btn btn-secondary 
                                {% if gym2_is_open %}d-none{% endif %}" 
                                data-gym-id="{{ gym2.id }}" 
                                data-url="{% url 'end_workout' gym2.id %}">
                            I'm Done Working Out
                        </button>
                    </div>
                    <!-- Reservation Button -->
                    <a href="{% url 'reservations' gym2.id %}" id="reservation-btn-2" class="btn btn-primary mt-3 
                            {% if not gym2_is_open %}disabled{% endif %}">
                        Make a Reservation
                    </a>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const socket = new WebSocket('ws://' + window.location.host + '/ws/gym-status/');

            gymStatusSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                document.querySelector('#gym-status').textContent = data.status ? 'Occupied' : 'Available';
            };

            gymStatusSocket.onclose = function(e) {
                console.error('Gym status socket closed unexpectedly');
            };

            function updateGymStatus(occupied) {
                gymStatusSocket.send(JSON.stringify({
                    'status': occupied
                }));
            }
            
        function toggleGymStatus(action, startButton, endButton, statusDiv, reservationButton, url) {
            fetch(url, { method: "GET" })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        const isOpen = action === "start" ? false : true;

                        // Update status text and styles
                        statusDiv.classList.toggle("bg-success", isOpen);
                        statusDiv.classList.toggle("bg-danger", !isOpen);
                        statusDiv.textContent = isOpen ? "Open" : "Occupied";

                        // Toggle button visibility
                        startButton.classList.toggle("d-none", !isOpen);
                        endButton.classList.toggle("d-none", isOpen);

                        // Enable/disable reservation button
                        reservationButton.classList.toggle("disabled", !isOpen);
                    }
                })
                .catch(error => console.error("Error:", error));
        }

        // Gym 1 logic
        const startWorkout1 = document.getElementById("start-workout-1");
        const endWorkout1 = document.getElementById("end-workout-1");
        const status1 = document.getElementById("gym-status-1");
        const reservation1 = document.getElementById("reservation-btn-1");

        startWorkout1.addEventListener("click", function (e) {
            e.preventDefault();
            toggleGymStatus("start", startWorkout1, endWorkout1, status1, reservation1, startWorkout1.getAttribute("data-url"));
        });

        endWorkout1.addEventListener("click", function (e) {
            e.preventDefault();
            toggleGymStatus("end", startWorkout1, endWorkout1, status1, reservation1, endWorkout1.getAttribute("data-url"));
        });

        // Gym 2 logic
        const startWorkout2 = document.getElementById("start-workout-2");
        const endWorkout2 = document.getElementById("end-workout-2");
        const status2 = document.getElementById("gym-status-2");
        const reservation2 = document.getElementById("reservation-btn-2");

        startWorkout2.addEventListener("click", function (e) {
            e.preventDefault();
            toggleGymStatus("start", startWorkout2, endWorkout2, status2, reservation2, startWorkout2.getAttribute("data-url"));
        });

        endWorkout2.addEventListener("click", function (e) {
            e.preventDefault();
            toggleGymStatus("end", startWorkout2, endWorkout2, status2, reservation2, endWorkout2.getAttribute("data-url"));
        });
    });
</script>
{% endblock %}
